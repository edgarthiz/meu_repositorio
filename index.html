<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SMART ESTEIRA - Painel de Monitoramento Remoto</title>

<!-- Chart.js para o gráfico -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Biblioteca Paho MQTT para WebSocket -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/paho-mqtt.js"></script>

<style>
/* ... (todo o CSS permanece igual ao que já te enviei antes) ... */
</style>
</head>
<body>

<div class="container">
  <!-- ... o restante do conteúdo HTML permanece igual ... -->
</div>

<div class="user-box">
  <div class="status-label">Status MQTT</div>
  <div id="mqttStatus" class="status-mqtt">Desconectado</div>
  <div class="user-info">
    <img src="Cleber.jpeg" alt="Operador">
    <div class="name">Operador: Cleber</div>
  </div>
</div>

<script>
/* ... referências a elementos DOM e setup do gráfico e gauges permanecem iguais ... */

/* ========= MQTT HiveMQ ========= */
const mqttHost   = "a3b0a2c2c0034765b38f3d7cff40fc25.s1.eu.hivemq.cloud";
const mqttPort   = 8884;
const mqttPath   = "/mqtt";
const mqttUser   = "edgar_thiz";
const mqttPass   = "Rg_1065736711@@";
const mqttTopic  = "smartesteira/dados";

const mqttClientId = "smartEsteiraWeb_" + Math.random().toString(16).substr(2,8);
let mqttClient = null;

function setMqttStatus(text, color){
  mqttStatusEl.textContent = text;
  mqttStatusEl.style.background = color;
}

function connectMQTT(){
  const wsUrl = `wss://${mqttHost}:${mqttPort}${mqttPath}`;
  console.log("Tentando conectar em:", wsUrl);

  mqttClient = new Paho.Client(wsUrl, mqttClientId);

  mqttClient.onConnectionLost = (responseObject) => {
    console.error("MQTT desconectado:", responseObject.errorMessage);
    setMqttStatus("Desconectado", "#b91d1d");
    setTimeout(connectMQTT, 3000);
  };

  mqttClient.onMessageArrived = (message) => {
    console.log("Mensagem recebida:", message.payloadString);
    try {
      const data = JSON.parse(message.payloadString);

      if (data.temperatura !== undefined) {
        const t = data.temperatura;
        tempEl.textContent = t.toFixed(1) + " °C";

        chartData.labels.push(new Date().toLocaleTimeString());
        chartData.datasets[0].data.push(t);

        if (chartData.labels.length > 10) {
          chartData.labels.shift();
          chartData.datasets[0].data.shift();
        }
        chart.update();
      }

      azulEl.textContent = data.azul;
      verdeEl.textContent = data.verde;
      vermelhoEl.textContent = data.vermelho;
      invalidoEl.textContent = data.invalido;
      totalEl.textContent = data.total;

    } catch (e) {
      console.error("Erro ao processar mensagem:", e);
    }
  };

  mqttClient.connect({
    useSSL: true,
    userName: mqttUser,
    password: mqttPass,
    onSuccess: () => {
      console.log("Conectado ao HiveMQ WebSocket!");
      setMqttStatus("Conectado", "#177a2f");
      mqttClient.subscribe(mqttTopic);
    },
    onFailure: (err) => {
      console.error("Erro na conexão MQTT:", err.errorMessage);
      setMqttStatus("Falha", "#b91d1d");
      setTimeout(connectMQTT, 3000);
    }
  });
}

window.addEventListener("load", () => {
  drawGaugeImmediate("gaugeA", dispA, 0);
  drawGaugeImmediate("gaugeB", dispB, 0);
  connectMQTT();
});
</script>

</body>
</html>
