<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Painel Industrial Smart Esteira - ESP32</title>

  <!-- MQTT + Chart.js -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* --- estilo industrial escuro --- */
    :root {
      --bg: #1b1b1b;
      --panel: #2b2b2b;
      --muted: #aaa;
      --accent: #ffc107;
    }
    html,body{height:100%;margin:0;font-family:"Segoe UI",Roboto,Arial,sans-serif;background:var(--bg);color:#eee}
    header{background:#0d6efd;color:#fff;padding:18px 22px;font-size:1.6rem;font-weight:700;box-shadow:0 3px 6px rgba(0,0,0,0.4)}
    .container{max-width:980px;margin:22px auto;background:var(--panel);padding:26px;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,0.6)}
    .led-panel{display:flex;justify-content:space-around;flex-wrap:wrap;margin-bottom:26px;gap:8px}
    .led-item{display:flex;flex-direction:column;align-items:center;width:140px}
    .led-label{font-size:0.9rem;color:#cfcfcf;margin-bottom:8px}
    .led-circle{width:110px;height:110px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.6rem;font-weight:800;color:#fff;box-shadow:0 6px 12px rgba(0,0,0,0.6);transition:transform .22s,box-shadow .22s,opacity .22s}
    .led-circle.changed{transform:scale(1.08);opacity:.95}
    .led-circle.flash{box-shadow:0 0 28px 8px rgba(255,215,0,0.15);transform:scale(1.12)}
    #led-azul{background:#007BFF}
    #led-verde{background:#28a745}
    #led-vermelho{background:#dc3545}
    #led-invalido{background:#000}
    #led-total{background:#6c757d}
    .temp-panel{background:#1a1a1a;padding:20px;border-radius:12px;margin-bottom:8px;transition:background-color .3s}
    .temp-panel.alert{background:#dc3545;animation:blink .9s infinite}
    @keyframes blink{0%,50%,100%{opacity:1}25%,75%{opacity:.5}}
    .temp-panel h2{color:var(--accent);margin:0 0 8px}
    .temp-info{color:#ddd;margin-bottom:8px}
    .status{display:inline-block;padding:8px 12px;border-radius:18px;margin-top:8px}
    .online{background:#28a745;color:#fff}
    .offline{background:#dc3545;color:#fff}
    canvas{width:100%;height:320px;border-radius:10px;background:#111}
    footer{color:var(--muted);text-align:center;margin-top:18px}
    /* mobile */
    @media(max-width:720px){ .led-item{width:120px} canvas{height:260px} }
  </style>
</head>
<body>
  <header>ðŸ’¡ Painel Industrial - Smart Esteira</header>

  <div class="container">
    <div class="led-panel">
      <div class="led-item">
        <div class="led-label">Qtde objetos azuis</div>
        <div id="led-azul" class="led-circle">0</div>
      </div>
      <div class="led-item">
        <div class="led-label">Qtde objetos verdes</div>
        <div id="led-verde" class="led-circle">0</div>
      </div>
      <div class="led-item">
        <div class="led-label">Qtde objetos vermelhos</div>
        <div id="led-vermelho" class="led-circle">0</div>
      </div>
      <div class="led-item">
        <div class="led-label">Objetos invÃ¡lidos</div>
        <div id="led-invalido" class="led-circle">0</div>
      </div>
      <div class="led-item">
        <div class="led-label">Total de objetos</div>
        <div id="led-total" class="led-circle">0</div>
      </div>
    </div>

    <div id="tempPanel" class="temp-panel">
      <h2>Temperatura do Motor da Esteira</h2>
      <div class="temp-info">Ãšltima leitura: <span id="temp">-- Â°C</span></div>
      <div class="temp-info">Ãšltima atualizaÃ§Ã£o: <span id="lastUpdate">--</span></div>
      <canvas id="tempChart"></canvas>
    </div>

    <div id="status" class="status offline">Desconectado</div>
  </div>

  <!-- Sirene (som simples). O navegador pode bloquear reproduÃ§Ã£o automÃ¡tica; o usuÃ¡rio pode permitir -->
  <audio id="sirene" loop preload="auto">
    <source src="https://www.soundjay.com/button/beep-07.mp3" type="audio/mpeg">
  </audio>

  <footer>Dados recebidos via HiveMQ Cloud MQTT â€” tÃ³pico: <strong>smartesteira/dados</strong></footer>

<script>
/* ======= CONFIGURAÃ‡ÃƒO MQTT (ajuste somente se necessÃ¡rio) ======= */
const HIVE_HOST = "a3b0a2c2c0034765b38f3d7cff40fc25.s1.eu.hivemq.cloud";
const WSS_PORT = 8884; // usual porta WSS do HiveMQ Cloud. Se usar outra porta, ajuste aqui.
const broker = `wss://${HIVE_HOST}:${WSS_PORT}/mqtt`;
const mqttOptions = {
  username: "edgar_thiz",
  password: "Rg_1065736711@@",
  clean: true,
  connectTimeout: 4000,
  reconnectPeriod: 3000,
  // protocolVersion: 4 // MQTT v3.1.1 (mqtt.js defaults usually OK)
};
const topic = "smartesteira/dados";

/* ======= ELEMENTS ======= */
const statusEl = document.getElementById("status");
const lastUpdateEl = document.getElementById("lastUpdate");
const tempPanel = document.getElementById("tempPanel");
const sirene = document.getElementById("sirene");

const ledButtons = {
  azul: document.getElementById("led-azul"),
  verde: document.getElementById("led-verde"),
  vermelho: document.getElementById("led-vermelho"),
  invalido: document.getElementById("led-invalido"),
  total: document.getElementById("led-total"),
  temp: document.getElementById("temp")
};

/* ======= Chart.js setup (corrected for dark bg) ======= */
const ctx = document.getElementById("tempChart").getContext("2d");
const chartData = {
  labels: [],
  datasets: [{
    label: "Temperatura (Â°C)",
    data: [],
    borderColor: "#ffc107",
    backgroundColor: "rgba(255,193,7,0.35)",
    borderWidth: 3,
    tension: 0.35,
    fill: true,
    pointRadius: 4,
    pointHoverRadius: 6,
    pointBackgroundColor: "#ffeb3b"
  }]
};

const tempChart = new Chart(ctx, {
  type: "line",
  data: chartData,
  options: {
    animation: false,
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: { labels: { color: "#eee" } }
    },
    scales: {
      x: {
        ticks: { color: "#ddd" },
        grid: { color: "rgba(255,255,255,0.03)" },
        title: { display: true, text: "HorÃ¡rio", color: "#bbb" }
      },
      y: {
        ticks: { color: "#ddd" },
        grid: { color: "rgba(255,255,255,0.03)" },
        title: { display: true, text: "Â°C", color: "#bbb" },
        beginAtZero: false
      }
    }
  }
});

/* ======= MQTT client ======= */
const client = mqtt.connect(broker, mqttOptions);

/* state */
let previousValues = {};
let flashInterval = null;

/* ======= helper updates ======= */
function setStatus(connected) {
  if (connected) {
    statusEl.classList.remove("offline");
    statusEl.classList.add("online");
    statusEl.textContent = "Conectado";
  } else {
    statusEl.classList.remove("online");
    statusEl.classList.add("offline");
    statusEl.textContent = "Desconectado";
  }
}

function safeParseFloat(v){ const n=parseFloat(v); return isFinite(n)?n:0; }

/* update dashboard with JSON 'dados' */
function updateParams(dados) {
  const now = new Date().toLocaleTimeString("pt-BR");
  lastUpdateEl.innerText = now;

  // temperatura field in ESP32 JSON is "temperatura"
  const tempNumeric = safeParseFloat(dados.temperatura ?? dados.temp ?? NaN);
  const tempValueText = (isNaN(tempNumeric) ? "--" : tempNumeric.toFixed(2)) + " Â°C";

  if (previousValues.temp !== tempValueText) {
    ledButtons.temp.innerText = tempValueText;
    previousValues.temp = tempValueText;
  }

  // update counts (fallback to 0)
  ["azul","verde","vermelho","invalido","total"].forEach(key=>{
    const value = (typeof dados[key] !== "undefined") ? dados[key] : 0;
    if (previousValues[key] !== String(value)) {
      ledButtons[key].innerText = String(value);
      ledButtons[key].classList.add("changed");
      setTimeout(()=>ledButtons[key].classList.remove("changed"),450);
      previousValues[key] = String(value);
    }
  });

  // push to chart (last 10 readings)
  if (!isNaN(tempNumeric)) {
    chartData.labels.push(now);
    chartData.datasets[0].data.push(tempNumeric);
    if (chartData.labels.length > 10) {
      chartData.labels.shift();
      chartData.datasets[0].data.shift();
    }
    tempChart.update();
    // force redraw for some browsers
    ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);
    tempChart.resize();
  }

  // ALERT: temperature threshold 50Â°C
  if (tempNumeric > 50) {
    tempPanel.classList.add("alert");
    // play siren (may require user interaction permission)
    if (sirene.paused) {
      // try play; browsers may block - user action may be required
      sirene.play().catch(()=>{/* autoplay blocked */});
    }
    // start flashing circles
    if (!flashInterval) {
      flashInterval = setInterval(()=>{
        ["azul","verde","vermelho","invalido","total"].forEach(k=>{
          ledButtons[k].classList.toggle("flash");
        });
      }, 500);
    }
  } else {
    tempPanel.classList.remove("alert");
    if (!sirene.paused) { sirene.pause(); sirene.currentTime = 0; }
    if (flashInterval) {
      clearInterval(flashInterval);
      flashInterval = null;
      ["azul","verde","vermelho","invalido","total"].forEach(k=>ledButtons[k].classList.remove("flash"));
    }
  }
}

/* ======= MQTT event handlers ======= */
client.on("connect", ()=> {
  console.log("MQTT conectado", broker);
  setStatus(true);
  client.subscribe(topic, (err)=> {
    if (err) console.warn("subscribe error:", err);
    else console.log("Subscribed to", topic);
  });
});

client.on("reconnect", ()=> {
  console.log("Reconectando MQTT...");
  setStatus(false);
});

client.on("error", (err) => {
  console.error("MQTT error:", err);
  setStatus(false);
});

client.on("offline", ()=> setStatus(false));

client.on("message", (t, message) => {
  try {
    const payload = message.toString();
    // debug
    // console.log("MSG", t, payload);
    const dados = JSON.parse(payload);
    updateParams(dados);
  } catch(e) {
    console.error("Falha ao parsear mensagem MQTT:", e, message.toString());
  }
});

/* Safety: if page is closed/hidden stop siren */
window.addEventListener("visibilitychange", ()=>{
  if (document.hidden && sirene && !sirene.paused) {
    sirene.pause();
  }
});
</script>
</body>
</html>
