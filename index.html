<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SMART ESTEIRA - MONITORAMENTO</title>

  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      background-color: #0f1115;
      color: #fff;
      font-family: 'Segoe UI', sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
    }

    h1 {
      margin-top: 20px;
      font-size: 2.8em;
      color: #00bfff;
      text-shadow: 0 0 15px #00bfff;
    }

    h2 {
      margin-top: -10px;
      color: #00bfff;
      text-shadow: 0 0 10px #00bfff;
      font-size: 1.4em;
    }

    /* Caixas de contadores */
    .status-container {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 20px auto;
      flex-wrap: wrap;
    }

    .box {
      width: 130px;
      height: 70px;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      font-weight: bold;
      box-shadow: 0 0 15px rgba(255,255,255,0.15);
      border: 2px solid #fff;
    }

    .azul { background-color: #007bff; }
    .verde { background-color: #28a745; }
    .vermelho { background-color: #dc3545; }
    .invalido { background-color: #000; }
    .total { background-color: #555; }

    /* Cart√£o de temperatura */
    .temp-card {
      background-color: #f39c12;
      color: black;
      display: inline-block;
      padding: 20px 40px;
      border-radius: 15px;
      margin-top: 10px;
      font-size: 1.2em;
      font-weight: bold;
      box-shadow: 0 0 15px #f39c12;
    }

    /* Bot√£o silenciar */
    #silenciarBtn {
      display: none;
      margin-top: 10px;
      background-color: #444;
      color: white;
      border: 2px solid #aaa;
      border-radius: 8px;
      padding: 6px 14px;
      cursor: pointer;
      transition: 0.3s;
    }
    #silenciarBtn:hover {
      background-color: #666;
    }

    /* Gr√°fico */
    .chart-container {
      width: 70%;
      margin: 25px auto;
      background-color: #1e1f25;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 0 12px rgba(255,255,255,0.1);
    }

    /* Usu√°rio com foto */
    .usuario {
      position: absolute;
      top: 20px;
      right: 30px;
      color: #f0f0f0;
      font-size: 1em;
      display: flex;
      align-items: center;
      gap: 10px;
      background: rgba(255,255,255,0.05);
      padding: 6px 12px;
      border-radius: 12px;
      border: 1px solid #f2c200;
      box-shadow: 0 0 8px #f2c20080;
    }

    .usuario img {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: 2px solid #f2c200;
      object-fit: cover;
    }

    canvas {
      margin-top: 10px;
    }

    @media (max-width: 800px) {
      .chart-container {
        width: 95%;
      }
    }
  </style>
</head>

<body>
  <div class="usuario">
    <img id="fotoUsuario" src="default.jpeg" alt="Foto do Operador">
    <div id="nomeUsuario">Usu√°rio: --</div>
  </div>

  <h1>SMART ESTEIRA</h1>
  <h2>MONITORAMENTO</h2>

  <div class="status-container">
    <div class="box azul">Azul<br><span id="azul">0</span></div>
    <div class="box verde">Verde<br><span id="verde">0</span></div>
    <div class="box vermelho">Vermelho<br><span id="vermelho">0</span></div>
    <div class="box invalido">Inv√°lido<br><span id="invalido">0</span></div>
    <div class="box total">Total<br><span id="total">0</span></div>
  </div>

  <div class="temp-card" id="tempCard">
    Temperatura do Motor da Esteira<br>
    <span id="temperatura">-- ¬∞C</span>
  </div>

  <br>
  <button id="silenciarBtn" onclick="silenciarAlerta()">üîá Silenciar Alerta</button>

  <div class="chart-container">
    <canvas id="graficoTemp"></canvas>
  </div>

  <script>
    // === MQTT CONFIG ===
    const client = mqtt.connect("wss://a3b0a2c2c0034765b38f3d7cff40fc25.s1.eu.hivemq.cloud:8884/mqtt", {
      username: "edgar_thiz",
      password: "Rg_1065736711@@"
    });

    client.on("connect", () => {
      console.log("‚úÖ Conectado ao broker MQTT");
      client.subscribe("smartesteira/dados");
    });

    client.on("message", (topic, message) => {
      try {
        const data = JSON.parse(message.toString());
        atualizarDados(data);
      } catch (e) {
        console.error("Erro ao processar JSON:", e);
      }
    });

    // === VARI√ÅVEIS ===
    let alertaAtivo = false;
    let audioSirene;

    const ctx = document.getElementById("graficoTemp").getContext("2d");
    const chart = new Chart(ctx, {
      type: "line",
      data: {
        labels: [],
        datasets: [{
          label: "Temperatura (¬∞C)",
          data: [],
          borderColor: "yellow",
          backgroundColor: "rgba(255,255,0,0.2)",
          borderWidth: 2,
          tension: 0.3,
          pointRadius: 4,
          pointBackgroundColor: "yellow"
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: { beginAtZero: false, ticks: { color: "#ccc" } },
          x: { ticks: { color: "#ccc" } }
        },
        plugins: { legend: { labels: { color: "yellow" } } }
      }
    });

    // === Atualiza√ß√£o dos dados MQTT ===
    function atualizarDados(d) {
      document.getElementById("azul").innerText = d.azul;
      document.getElementById("verde").innerText = d.verde;
      document.getElementById("vermelho").innerText = d.vermelho;
      document.getElementById("invalido").innerText = d.invalido;
      document.getElementById("total").innerText = d.total;
      document.getElementById("temperatura").innerText = d.temperatura.toFixed(1) + " ¬∞C";

      atualizarUsuario(d.usuario);
      atualizarGrafico(d.temperatura);
      verificarAlerta(d.temperatura);
    }

    // === Atualiza nome e foto do operador ===
    function atualizarUsuario(nome) {
      document.getElementById("nomeUsuario").innerText = "Usu√°rio: " + (nome || "--");
      const foto = document.getElementById("fotoUsuario");
      if (!nome) { foto.src = "default.jpeg"; return; }
      const n = nome.toLowerCase();
      if (n.includes("cleber")) foto.src = "Cleber.jpeg";
      else if (n.includes("edgar")) foto.src = "Edgar.jpeg";
      else foto.src = "default.jpeg";
    }

    // === Gr√°fico de temperatura ===
    function atualizarGrafico(temp) {
      const agora = new Date().toLocaleTimeString();
      chart.data.labels.push(agora);
      chart.data.datasets[0].data.push(temp);
      if (chart.data.labels.length > 20) {
        chart.data.labels.shift();
        chart.data.datasets[0].data.shift();
      }
      chart.update();
    }

    // === Alerta de temperatura ===
    function verificarAlerta(temp) {
      const limite = 50;
      const tempCard = document.getElementById("tempCard");
      const btn = document.getElementById("silenciarBtn");

      if (temp >= limite && !alertaAtivo) {
        alertaAtivo = true;
        tempCard.style.backgroundColor = "#ff0000";
        tempCard.style.boxShadow = "0 0 25px #ff0000";
        btn.style.display = "inline-block";

        audioSirene = new Audio("https://cdn.pixabay.com/download/audio/2022/03/15/audio_8dd52f2650.mp3?filename=factory-alarm-108323.mp3");
        audioSirene.loop = true;
        audioSirene.play().catch(err => console.log("‚ö†Ô∏è Erro ao tocar sirene:", err));

      } else if (temp < limite && alertaAtivo) {
        alertaAtivo = false;
        tempCard.style.backgroundColor = "#f39c12";
        tempCard.style.boxShadow = "0 0 15px #f39c12";
        btn.style.display = "none";
        if (audioSirene) audioSirene.pause();
      }
    }

    // === Silenciar manualmente ===
    function silenciarAlerta() {
      if (audioSirene) audioSirene.pause();
      document.getElementById("silenciarBtn").style.display = "none";
    }
  </script>
</body>
</html>
