<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Painel Industrial Smart Esteira</title>
<script src="https://cdn.jsdelivr.net/npm/mqtt/dist/mqtt.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body{
  background-color:#1a1a1a;
  color:#fff;
  font-family:Arial, Helvetica, sans-serif;
  margin:0;
  padding:0;
  display:flex;
  justify-content:center;
}
.container{
  width:90%;
  max-width:1100px;
  background:#2b2b2b;
  padding:30px;
  margin-top:30px;
  border-radius:20px;
  box-shadow:0 0 25px rgba(255,255,255,0.05);
}
h1{
  text-align:center;
  color:#f2c200;
  margin-bottom:40px;
}
.led-panel{
  display:flex;
  flex-wrap:wrap;
  justify-content:space-evenly;
  align-items:center; /* corrigido */
  gap:16px;
  margin-bottom:28px;
}
.led{
  width:110px;
  height:110px;
  border-radius:50%;
  display:flex;
  justify-content:center;
  align-items:center;
  font-size:28px;
  font-weight:bold;
  color:#fff;
  box-shadow:0 0 10px rgba(0,0,0,0.4);
}
.led-label{
  text-align:center;
  margin-bottom:5px;
  font-weight:bold;
}
.blue{background:#007bff;}
.green{background:#28a745;}
.red{background:#dc3545;}
.black{background:#000;}
.gray{background:#555;}
.card{
  background:#1e1e1e;
  border-radius:16px;
  padding:20px;
  text-align:center;
}
.card h2{
  color:#f2c200;
}
.status{
  text-align:center;
  margin-top:20px;
  padding:10px;
  border-radius:10px;
  font-weight:bold;
}
.status.connected{background:#28a745;}
.status.disconnected{background:#dc3545;}
canvas{
  width:100%!important;
  max-height:320px;
}
.alerta{
  animation:piscar 0.6s infinite alternate;
}
@keyframes piscar{
  from{color:#fff;}
  to{color:#ff0000;}
}
</style>
</head>
<body>
<div class="container">
  <h1>Painel Industrial Smart Esteira</h1>

  <div class="led-panel">
    <div>
      <div class="led-label">Qtde objetos azuis</div>
      <div class="led blue" id="azul">0</div>
    </div>
    <div>
      <div class="led-label">Qtde objetos verdes</div>
      <div class="led green" id="verde">0</div>
    </div>
    <div>
      <div class="led-label">Qtde objetos vermelhos</div>
      <div class="led red" id="vermelho">0</div>
    </div>
    <div>
      <div class="led-label">Objetos inválidos</div>
      <div class="led black" id="invalido">0</div>
    </div>
    <div>
      <div class="led-label">Total de objetos</div>
      <div class="led gray" id="total">0</div>
    </div>
  </div>

  <div class="card">
    <h2>Temperatura do Motor da Esteira</h2>
    <p>Última leitura: <span id="temp">--</span> °C</p>
    <p>Última atualização: <span id="hora">--:--:--</span></p>
    <canvas id="grafico"></canvas>
  </div>

  <div class="status disconnected" id="status">Desconectado</div>
</div>

<script>
// ===== CONFIGURAÇÃO MQTT =====
const broker = "wss://a3b0a2c2c0034765b38f3d7cff40fc25.s1.eu.hivemq.cloud:8884/mqtt";
const options = {
  username: "edgar_thiz",
  password: "Rg_1065736711@@",
  clean: true,
  connectTimeout: 4000,
  reconnectPeriod: 5000
};
const client = mqtt.connect(broker, options);
const topic = "smartesteira/dados";

// ===== ELEMENTOS =====
const s = id => document.getElementById(id);
const leds = {azul:s("azul"),verde:s("verde"),vermelho:s("vermelho"),invalido:s("invalido"),total:s("total")};
const statusDiv = s("status");
const tempSpan = s("temp");
const horaSpan = s("hora");

// ===== GRÁFICO =====
const ctx = document.getElementById("grafico").getContext("2d");
const chartData = {labels:[],datasets:[{label:"Temperatura (°C)",borderColor:"#f2c200",backgroundColor:"rgba(242,194,0,0.2)",data:[],tension:0.2,fill:true}]};
const grafico = new Chart(ctx,{
  type:"line",
  data:chartData,
  options:{
    responsive:true,
    maintainAspectRatio:false,
    scales:{
      x:{
        ticks:{color:"#ddd"},
        grid:{color:"rgba(255,255,255,0.1)"}
      },
      y:{
        min:0,
        suggestedMax:60,
        ticks:{color:"#ddd"},
        grid:{color:"rgba(255,255,255,0.1)"},
        title:{display:true,text:"Temperatura (°C)",color:"#bbb"}
      }
    },
    plugins:{legend:{labels:{color:"#f2c200"}}}
  }
});

// ===== FUNÇÕES =====
client.on("connect",()=>{
  statusDiv.textContent="Conectado";
  statusDiv.className="status connected";
  client.subscribe(topic);
});
client.on("reconnect",()=>{
  statusDiv.textContent="Reconectando...";
  statusDiv.className="status disconnected";
});
client.on("offline",()=>{
  statusDiv.textContent="Desconectado";
  statusDiv.className="status disconnected";
});
client.on("message",(t,p)=>{
  if(t===topic){
    try{
      const dados = JSON.parse(p.toString());
      atualizarDados(dados);
    }catch(e){console.error("Erro JSON",e);}
  }
});

function atualizarDados(d){
  // atualiza contadores
  leds.azul.textContent=d.azul??0;
  leds.verde.textContent=d.verde??0;
  leds.vermelho.textContent=d.vermelho??0;
  leds.invalido.textContent=d.invalido??0;
  leds.total.textContent=d.total??0;

  // temperatura
  const temp = d.temperatura??0;
  tempSpan.textContent=temp.toFixed(2);
  const agora = new Date();
  const label = agora.toLocaleTimeString("pt-BR",{hour12:false});
  horaSpan.textContent=label;

  // evita labels duplicados
  if(chartData.labels.length>0 && chartData.labels[chartData.labels.length-1]===label) return;
  chartData.labels.push(label);
  chartData.datasets[0].data.push(temp);

  // mantém 10 amostras
  if(chartData.labels.length>10){
    chartData.labels.shift();
    chartData.datasets[0].data.shift();
  }
  grafico.update();

  // alerta visual
  if(d.alerta){
    tempSpan.classList.add("alerta");
  }else{
    tempSpan.classList.remove("alerta");
  }
}
</script>
</body>
</html>
