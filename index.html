<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Painel Industrial Smart Esteira</title>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root {
  --bg: #1b1b1b;
  --panel: #2b2b2b;
  --muted: #aaa;
  --accent: #ffc107;
}
html,body{
  margin:0;
  font-family:"Segoe UI",Roboto,Arial,sans-serif;
  background:var(--bg);
  color:#eee;
}
header{
  background:#0d6efd;
  color:#fff;
  padding:18px 22px;
  font-size:1.5rem;
  font-weight:700;
  text-align:center;
  box-shadow:0 3px 6px rgba(0,0,0,0.4)
}
.container{
  max-width:960px;
  margin:20px auto;
  background:var(--panel);
  padding:22px;
  border-radius:12px;
  box-shadow:0 6px 18px rgba(0,0,0,0.6)
}

/* === Painel de LEDs === */
.led-panel{
  display:flex;
  flex-wrap:wrap;
  justify-content:space-evenly;
  align-items:flex-start;
  gap:16px;
  margin-bottom:28px;
}
.led-item{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:flex-start;
  width:150px;
  text-align:center;
}
.led-label{
  font-size:0.9rem;
  color:#cfcfcf;
  margin-bottom:8px
}
.led-circle{
  width:110px;
  height:110px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:1.6rem;
  font-weight:800;
  color:#fff;
  box-shadow:0 6px 12px rgba(0,0,0,0.6);
  transition:transform .22s,box-shadow .22s,opacity .22s;
}
.led-circle.changed{transform:scale(1.08);opacity:.95}
.led-circle.flash{box-shadow:0 0 28px 8px rgba(255,215,0,0.15);transform:scale(1.12)}

#led-azul{background:#007bff}
#led-verde{background:#28a745}
#led-vermelho{background:#dc3545}
#led-invalido{background:#000}
#led-total{background:#6c757d}

/* === Temperatura === */
.temp-panel{
  background:#1a1a1a;
  padding:20px;
  border-radius:12px;
  transition:background-color .3s;
  margin-bottom:12px
}
.temp-panel.alert{
  background:#dc3545;
  animation:blink .9s infinite
}
@keyframes blink{
  0%,50%,100%{opacity:1}
  25%,75%{opacity:.5}
}
.temp-panel h2{color:var(--accent);margin:0 0 8px}
.temp-info{color:#ddd;margin-bottom:8px}
.status{
  display:inline-block;
  padding:8px 12px;
  border-radius:18px;
  margin-top:8px
}
.online{background:#28a745;color:#fff}
.offline{background:#dc3545;color:#fff}

/* === GrÃ¡fico corrigido === */
.chart-container{
  width:100%;
  max-height:320px;
  height:320px;
  overflow:hidden;
  border-radius:10px;
  background:#111;
}
canvas{
  width:100% !important;
  height:100% !important;
}

/* === Footer e responsividade === */
footer{color:var(--muted);text-align:center;margin-top:20px}
@media(max-width:720px){
  .led-item{width:120px}
  .chart-container{height:240px}
}
</style>
</head>

<body>
<header>ðŸ’¡ Painel Industrial - Smart Esteira</header>

<div class="container">
  <div class="led-panel">
    <div class="led-item">
      <div class="led-label">Qtde objetos azuis</div>
      <div id="led-azul" class="led-circle">0</div>
    </div>
    <div class="led-item">
      <div class="led-label">Qtde objetos verdes</div>
      <div id="led-verde" class="led-circle">0</div>
    </div>
    <div class="led-item">
      <div class="led-label">Qtde objetos vermelhos</div>
      <div id="led-vermelho" class="led-circle">0</div>
    </div>
    <div class="led-item">
      <div class="led-label">Objetos invÃ¡lidos</div>
      <div id="led-invalido" class="led-circle">0</div>
    </div>
    <div class="led-item">
      <div class="led-label">Total de objetos</div>
      <div id="led-total" class="led-circle">0</div>
    </div>
  </div>

  <div id="tempPanel" class="temp-panel">
    <h2>Temperatura do Motor da Esteira</h2>
    <div class="temp-info">Ãšltima leitura: <span id="temp">-- Â°C</span></div>
    <div class="temp-info">Ãšltima atualizaÃ§Ã£o: <span id="lastUpdate">--</span></div>
    <div class="chart-container">
      <canvas id="tempChart"></canvas>
    </div>
  </div>

  <div id="status" class="status offline">Desconectado</div>
</div>

<audio id="sirene" loop preload="auto">
  <source src="https://www.soundjay.com/button/beep-07.mp3" type="audio/mpeg">
</audio>

<footer>Dados via HiveMQ Cloud MQTT â€” tÃ³pico: <strong>smartesteira/dados</strong></footer>

<script>
const HIVE_HOST = "a3b0a2c2c0034765b38f3d7cff40fc25.s1.eu.hivemq.cloud";
const WSS_PORT = 8884; // mude para 8883 se seu WSS estiver nessa porta
const broker = `wss://${HIVE_HOST}:${WSS_PORT}/mqtt`;
const mqttOptions = {
  username:"edgar_thiz",
  password:"Rg_1065736711@@",
  clean:true,
  connectTimeout:4000,
  reconnectPeriod:3000
};
const topic="smartesteira/dados";

const statusEl=document.getElementById("status");
const tempPanel=document.getElementById("tempPanel");
const sirene=document.getElementById("sirene");
const lastUpdateEl=document.getElementById("lastUpdate");
const ledButtons={
  azul:document.getElementById("led-azul"),
  verde:document.getElementById("led-verde"),
  vermelho:document.getElementById("led-vermelho"),
  invalido:document.getElementById("led-invalido"),
  total:document.getElementById("led-total"),
  temp:document.getElementById("temp")
};

const ctx=document.getElementById("tempChart").getContext("2d");
const chartData={labels:[],datasets:[{label:"Temperatura (Â°C)",data:[],borderColor:"#ffc107",backgroundColor:"rgba(255,193,7,0.35)",borderWidth:2.5,tension:0.3,fill:true,pointRadius:4,pointBackgroundColor:"#ffeb3b"}]};
const tempChart=new Chart(ctx,{type:"line",data:chartData,options:{
  responsive:true,maintainAspectRatio:false,
  plugins:{legend:{labels:{color:"#eee"}}},
  scales:{
    x:{ticks:{color:"#ddd"},grid:{color:"rgba(255,255,255,0.05)"}},
    y:{ticks:{color:"#ddd"},grid:{color:"rgba(255,255,255,0.05)"},title:{display:true,text:"Â°C",color:"#bbb"}}
  }
}});

function setStatus(ok){statusEl.className="status "+(ok?"online":"offline");statusEl.textContent=ok?"Conectado":"Desconectado";}
const client=mqtt.connect(broker,mqttOptions);
let flash=null,prev={};

function updateDados(d){
  const agora=new Date().toLocaleTimeString("pt-BR");
  lastUpdateEl.textContent=agora;
  const temp=parseFloat(d.temperatura)||0;
  ledButtons.temp.textContent=temp.toFixed(1)+" Â°C";
  ["azul","verde","vermelho","invalido","total"].forEach(k=>{
    const v=d[k]||0;
    ledButtons[k].textContent=v;
  });
  chartData.labels.push(agora);
  chartData.datasets[0].data.push(temp);
  if(chartData.labels.length>10){chartData.labels.shift();chartData.datasets[0].data.shift();}
  tempChart.update();

  if(temp>50){
    tempPanel.classList.add("alert");
    sirene.play().catch(()=>{});
    if(!flash){
      flash=setInterval(()=>{
        ["azul","verde","vermelho","invalido","total"].forEach(k=>{
          ledButtons[k].classList.toggle("flash");
        });
      },500);
    }
  }else{
    tempPanel.classList.remove("alert");
    sirene.pause();sirene.currentTime=0;
    if(flash){clearInterval(flash);flash=null;["azul","verde","vermelho","invalido","total"].forEach(k=>ledButtons[k].classList.remove("flash"));}
  }
}

client.on("connect",()=>{setStatus(true);client.subscribe(topic);});
client.on("reconnect",()=>setStatus(false));
client.on("offline",()=>setStatus(false));
client.on("message",(t,msg)=>{
  try{updateDados(JSON.parse(msg.toString()));}
  catch(e){console.error("Erro JSON",e);}
});
</script>
</body>
</html>
