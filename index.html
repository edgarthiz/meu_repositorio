<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SMART ESTEIRA - Monitoramento</title>
<script src="https://cdn.jsdelivr.net/npm/mqtt/dist/mqtt.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {
  background-color: #0d1117;
  color: #fff;
  font-family: 'Segoe UI', sans-serif;
  margin: 0;
  padding: 0;
  text-align: center;
}

/* T√≠tulo */
header {
  margin-top: 25px;
}
h1 {
  font-size: 2.3em;
  color: #00e6ff;
  text-shadow: 0 0 20px #00e6ff;
  font-weight: bold;
  margin-bottom: 5px;
  letter-spacing: 1px;
}
h2 {
  font-size: 1.3em;
  color: #00e6ff;
  text-shadow: 0 0 10px #00e6ff;
  font-weight: 600;
  margin-top: 0;
}

/* Usu√°rio canto superior direito */
.usuario {
  position: absolute;
  top: 20px;
  right: 30px;
  color: #aaa;
  font-size: 0.9em;
}

/* Pain√©is */
.panel {
  display: flex;
  justify-content: center;
  gap: 16px;
  margin: 35px 0;
  flex-wrap: wrap;
}
.card {
  width: 140px;
  height: 80px;
  border-radius: 10px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  font-weight: bold;
  color: #fff;
  box-shadow: 0 0 10px rgba(0,0,0,0.4);
  border: 2px solid #f2c200; /* borda clara */
}
.blue { background: #007bff; }
.green { background: #28a745; }
.red { background: #dc3545; }
.black { background: #000; }
.gray { background: #555; }

/* Temperatura */
.temp-card {
  background: #f2a500;
  color: #000;
  display: inline-block;
  padding: 20px 40px;
  border-radius: 15px;
  font-size: 1.3em;
  font-weight: bold;
  box-shadow: 0 0 20px rgba(242,165,0,0.5);
  margin-bottom: 15px;
  transition: 0.2s;
}
.alerta {
  animation: piscar 0.6s infinite alternate;
}
@keyframes piscar {
  from { background-color: #f2a500; color: #000; }
  to { background-color: #ff0000; color: #fff; }
}

/* Bot√£o silenciar */
#btnSilenciar {
  display: none;
  background: #dc3545;
  color: #fff;
  padding: 10px 18px;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  font-weight: bold;
  margin-bottom: 10px;
  box-shadow: 0 0 8px rgba(255,0,0,0.4);
}
#btnSilenciar:hover { background: #ff4747; }

/* Gr√°fico */
.grafico {
  width: 90%;
  max-width: 900px;
  height: 380px;
  background: #161b22;
  margin: 0 auto 40px auto;
  border-radius: 15px;
  padding: 25px;
  box-shadow: 0 0 15px rgba(0,0,0,0.4);
  display: flex;
  justify-content: center;
  align-items: center;
}
canvas {
  width: 100% !important;
  height: 100% !important;
}
</style>
</head>
<body>
  <header>
    <h1>SMART ESTEIRA</h1>
    <h2>MONITORAMENTO</h2>
  </header>

  <div class="usuario">Usu√°rio: <span id="usuario">--</span></div>

  <div class="panel">
    <div class="card blue">Azul<br><span id="azul">0</span></div>
    <div class="card green">Verde<br><span id="verde">0</span></div>
    <div class="card red">Vermelho<br><span id="vermelho">0</span></div>
    <div class="card black">Inv√°lido<br><span id="invalido">0</span></div>
    <div class="card gray">Total<br><span id="total">0</span></div>
  </div>

  <div id="tempBox" class="temp-card">
    Temperatura do Motor da Esteira<br><span id="temp">-- ¬∞C</span>
  </div>
  <br>
  <button id="btnSilenciar">üîá Silenciar Alerta</button>

  <div class="grafico">
    <canvas id="grafico"></canvas>
  </div>

  <audio id="alarme" src="https://actions.google.com/sounds/v1/alarms/siren.ogg" preload="auto" loop></audio>

<script>
const broker = "wss://a3b0a2c2c0034765b38f3d7cff40fc25.s1.eu.hivemq.cloud:8884/mqtt";
const options = {
  username: "edgar_thiz",
  password: "Rg_1065736711@@",
  clean: true,
  connectTimeout: 4000,
  reconnectPeriod: 5000
};
const topic = "smartesteira/dados";
const client = mqtt.connect(broker, options);

const s = id => document.getElementById(id);
const leds = { azul:s("azul"), verde:s("verde"), vermelho:s("vermelho"), invalido:s("invalido"), total:s("total") };
const usuarioSpan = s("usuario");
const tempSpan = s("temp");
const tempBox = s("tempBox");
const btnSilenciar = s("btnSilenciar");
const alarme = s("alarme");

const ctx = document.getElementById("grafico").getContext("2d");
const chartData = { labels:[], datasets:[{ label:"Temperatura (¬∞C)", borderColor:"#f2c200", backgroundColor:"rgba(242,194,0,0.25)", data:[], fill:true, tension:0.2, pointRadius:4, pointHoverRadius:6 }] };
const grafico = new Chart(ctx, {
  type:"line",
  data:chartData,
  options:{
    scales:{
      x:{ticks:{color:"#ccc"},grid:{color:"rgba(255,255,255,0.1)"}},
      y:{min:0,suggestedMax:60,ticks:{color:"#ccc"},grid:{color:"rgba(255,255,255,0.1)"}}
    },
    plugins:{legend:{labels:{color:"#f2c200"}}},
    animation:false
  }
});

let alarmeAtivo=false, silenciado=false, somAtivo=false;
document.body.addEventListener("click",()=>{somAtivo=true;},{once:true});

function atualizarCorGrafico(temp){
  if(temp>=50){
    grafico.data.datasets[0].borderColor="#ff0000";
    grafico.data.datasets[0].backgroundColor="rgba(255,0,0,0.2)";
  } else {
    grafico.data.datasets[0].borderColor="#f2c200";
    grafico.data.datasets[0].backgroundColor="rgba(242,194,0,0.25)";
  }
  grafico.update();
}

function dispararAlerta(){
  if(!alarmeAtivo && !silenciado){
    tempBox.classList.add("alerta");
    btnSilenciar.style.display="inline-block";
    alarme.play().catch(()=>{});
    alarmeAtivo=true;
  }
}

function pararAlerta(){
  alarme.pause(); alarme.currentTime=0;
  tempBox.classList.remove("alerta");
  btnSilenciar.style.display="none";
  alarmeAtivo=false;
}

btnSilenciar.onclick=()=>{silenciado=true; pararAlerta();}

client.on("connect",()=>{
  console.log("‚úÖ Conectado ao HiveMQ");
  client.subscribe(topic);
});
client.on("error",err=>console.error("Erro MQTT:",err));
client.on("message",(t,msg)=>{
  if(t===topic){
    const d=JSON.parse(msg.toString());
    atualizar(d);
  }
});

function atualizar(d){
  leds.azul.textContent=d.azul??0;
  leds.verde.textContent=d.verde??0;
  leds.vermelho.textContent=d.vermelho??0;
  leds.invalido.textContent=d.invalido??0;
  leds.total.textContent=d.total??0;
  usuarioSpan.textContent=d.usuario||"--";

  const temp=d.temperatura??0;
  tempSpan.textContent=temp.toFixed(1)+" ¬∞C";
  atualizarCorGrafico(temp);

  const label=new Date().toLocaleTimeString("pt-BR",{hour12:false});
  chartData.labels.push(label);
  chartData.datasets[0].data.push(temp);
  if(chartData.labels.length>12){
    chartData.labels.shift(); chartData.datasets[0].data.shift();
  }
  grafico.update();

  if(temp>=50) dispararAlerta();
  else pararAlerta();
}
</script>
</body>
</html>
