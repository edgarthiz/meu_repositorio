<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SMART ESTEIRA - Painel de Monitoramento</title>

<!-- Chart.js para o gráfico -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Biblioteca Paho MQTT -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

<style>
/* (CSS idêntico ao anterior) */
:root {
  --bg:#0f1112;
  --panel:#18191b;
  --accent:#f2c200;
  --text:#ffffff;
  --danger:#ff2e2e;
}
*{box-sizing:border-box;margin:0;padding:0}
body {
  background: var(--bg);
  font-family: "Segoe UI", Roboto, Arial, sans-serif;
  color: var(--text);
  display: flex;
  justify-content: center;
  padding: 20px;
}
.container { width: 95%; max-width: 1280px; }
header { text-align: center; margin-bottom: 10px; }
header h1 {
  color: #00d1ff; font-size: 40px;
  text-shadow: 0 0 20px #00d1ff;
}
header h2 {
  color: #00d1ff; font-size: 18px; margin: 6px 0 16px;
  text-shadow: 0 0 15px #00d1ff;
}
.user-box {
  position: fixed; top: 18px; right: 18px;
  display: flex; flex-direction: column; gap: 8px; align-items: center;
}
.status-label { font-size: 13px; color: #ccc; font-weight: 700; }
.status-mqtt {
  background: #b91d1d; padding: 6px 14px; border-radius: 8px;
  font-weight: 700; color: white; font-size: 13px; text-align: center;
}
.user-info {
  display: flex; align-items: center; background-color: #1b1c1e;
  border-radius: 10px; padding: 8px; gap: 10px;
}
.user-info img { width: 48px; height: 48px; border-radius: 50%; }
.user-info .name { font-size: 14px; font-weight: bold; }
.counters {
  display: flex; gap: 12px; justify-content: center; margin-bottom: 10px;
}
.counter {
  min-width: 120px; text-align: center; border-radius: 10px; padding: 8px;
  font-weight: bold; color: white; border: 2px solid white;
}
.counter.blue { background: #1677ff; }
.counter.green { background: #21893a; }
.counter.red { background: #b91d1d; }
.counter.black { background: #000; }
.counter.gray { background: #555; }
.temp-box {
  background: var(--accent); color: #111; padding: 10px;
  border-radius: 12px; text-align: center; box-shadow: 0 0 12px rgba(242,194,0,0.4);
}
.temp-box .label { font-weight: bold; }
.temp-box .value { margin-top: 5px; color: #c62828; font-size: 20px; }
.temp-alert { animation: blink 0.5s infinite alternate; }
@keyframes blink { from { background-color: var(--danger); } to { background-color: #ff4d4d; } }

.instrument {
  background: var(--panel); padding: 10px; border-radius: 10px; box-shadow: 0 0 12px rgba(0,0,0,0.5);
}
.seg7 {
  background: #000; color: var(--accent); font-family: monospace;
  font-size: 26px; border-radius: 6px; padding: 6px 0; text-align: center;
}
.gauge-container {
  position: relative; width: 100%; height: 120px; background: white;
  border-radius: 8px; padding: 6px;
}
.gauge-display {
  position: absolute; top: 5px; left: 50%; transform: translateX(-50%);
  color: var(--accent); font-family: monospace; font-size: 15px;
  background: #111; padding: 4px; border-radius: 4px;
}
.chart-wrap { background: var(--panel); padding: 10px; border-radius: 10px; height: 240px; }
</style>
</head>
<body>

<div class="container">
  <header>
    <h1>SMART ESTEIRA</h1>
    <h2>Painel de Monitoramento Remoto</h2>
  </header>
  
  <div class="counters">
    <div class="counter blue"><div>Azul</div><div id="azul">0</div></div>
    <div class="counter green"><div>Verde</div><div id="verde">0</div></div>
    <div class="counter red"><div>Vermelho</div><div id="vermelho">0</div></div>
    <div class="counter black"><div>Inválido</div><div id="invalido">0</div></div>
    <div class="counter gray"><div>Total</div><div id="total">0</div></div>
  </div>

  <div class="temp-box" id="tempBox">
    <div class="label">Temperatura do Motor</div>
    <div class="value" id="temp">-- °C</div>
  </div>

  <div class="main-row">
    <div class="instrument">
      <div class="seg7" id="segA">--.- V</div>
      <div class="gauge-container"><canvas id="gaugeA"></canvas><div class="gauge-display" id="dispA">--- mA</div></div>
    </div>
    <div class="chart-wrap"><canvas id="tempChart"></canvas></div>
    <div class="instrument">
      <div class="seg7" id="segB">--.- V</div>
      <div class="gauge-container"><canvas id="gaugeB"></canvas><div class="gauge-display" id="dispB">--- mA</div></div>
    </div>
  </div>
</div>

<div class="user-box">
  <div class="status-label">Status MQTT</div>
  <div id="mqttStatus" class="status-mqtt">Desconectado</div>
  <div class="user-info">
    <img src="Cleber.jpeg" alt="Operador"><div class="name">Cleber</div>
  </div>
</div>

<script>
const el = id => document.getElementById(id);
const tempEl = el('temp'), tempBox = el('tempBox');
const verdeEl = el('verde'), azulEl = el('azul');
const vermelhoEl = el('vermelho'), invalidoEl = el('invalido'), totalEl = el('total');
const mqttStatusEl = el('mqttStatus');
const ctx = el('tempChart').getContext('2d');

const mqttHost = "a3b0a2c2c0034765b38f3d7cff40fc25.s1.eu.hivemq.cloud";
const mqttUser = "edgar_thiz", mqttPass = "Rg_1065736711@@";
const mqttTopic = "smartesteira/dados";
const mqttClientId = "smartEsteiraWeb_" + Math.random().toString(16).substr(2,8);

const chartData = {labels:[],datasets:[{label:"Temp (°C)",data:[],borderColor:"#f2c200"}]};
const chart = new Chart(ctx,{type:"line",data:chartData,options:{responsive:true,scales:{y:{suggestedMax:80}}}});

let mqttClient;

function drawGauge(id, displayEl, value){
  const c = el(id); const ctx = c.getContext('2d');
  c.width = c.clientWidth; c.height = c.clientHeight;
  ctx.clearRect(0,0,c.width,c.height);
  const center = {x:c.width/2, y:c.height*0.9}, radius = c.height/2.2;
  ctx.beginPath(); ctx.arc(center.x, center.y, radius, Math.PI, 0); ctx.stroke();
  const angle = Math.PI + (value/1000 * Math.PI);
  ctx.lineWidth = 6; ctx.beginPath(); ctx.moveTo(center.x,ctx.height); ctx.lineTo(center.x+Math.cos(angle)*radius,center.y+Math.sin(angle)*radius); ctx.stroke();
  displayEl.textContent = Math.round(value)+" mA";
}

function updateUI(data){
  const t = data.temperatura;
  tempEl.innerText = t.toFixed(1)+" °C";
  if(t >= 50){ tempBox.classList.add('temp-alert'); } else { tempBox.classList.remove('temp-alert'); }
  
  chartData.labels.push(new Date().toLocaleTimeString());
  chartData.datasets[0].data.push(t);
  if(chartData.labels.length > 12){ chartData.labels.shift(); chartData.datasets[0].data.shift(); }
  chart.update();
  
  azulEl.textContent = data.azul;
  verdeEl.textContent = data.verde;
  vermelhoEl.textContent = data.vermelho;
  invalidoEl.textContent = data.invalido;
  totalEl.textContent = data.total;
}

function connectMQTT(){
  mqttClient = new Paho.Client(`wss://${mqttHost}:8884/mqtt`, mqttClientId);
  mqttClient.onConnectionLost = () => { mqttStatusEl.innerText = "Desconectado"; mqttStatusEl.style.background = "#b91d1d"; };
  mqttClient.onMessageArrived = msg => { console.log("MQTT:", msg.payloadString); updateUI(JSON.parse(msg.payloadString)); };
  mqttClient.connect({
    useSSL:true, userName:mqttUser, password:mqttPass,
    onSuccess:() => { 
      mqttStatusEl.innerText = "Conectado"; mqttStatusEl.style.background = "#15803d";
      mqttClient.subscribe(mqttTopic); 
      drawGauge('gaugeA', el('dispA'), 0);
      drawGauge('gaugeB', el('dispB'), 0);
    },
    onFailure:()=>{ mqttStatusEl.innerText = "Falha"; mqttStatusEl.style.background = "#b91d1d"; }
  });
}

window.onload = connectMQTT;
</script>

</body>
</html>
